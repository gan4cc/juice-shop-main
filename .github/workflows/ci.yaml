name: DevSecOps Example Workflows

on:
  workflow_dispatch:
    inputs:
      node-version:
        description: Node.js version
        type: choice
        default: '22'
        required: true
        options: ['18', '20', '22']
      dc-version:
        description: OWASP Dependency Check version
        default: '12.1.9'
        required: true
      gitleaks:
        type: boolean
        default: false
        required: true
      trufflehog:
        type: boolean
        default: false
        required: true
      semgrep:
        type: boolean
        default: false
        required: true
      sbom:
        type: boolean
        default: false
        required: true
      owasp-depcheck:
        type: boolean
        default: false
        required: true
      trivy:
        type: boolean
        default: false
        required: true
      zap:
        type: boolean
        default: false
        required: true

permissions:
  actions: write
  packages: write
  contents: read

env:
  GITHUB_DOCKER_REGISTRY: ghcr.io/gan4cc
  IMAGE_NAME: juicy-shop

# ---------------------------------------------------------
# üîê Secrets scanning
# ---------------------------------------------------------
jobs:
  secrets_scan:
    if: inputs.gitleaks || inputs.trufflehog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with: { fetch-depth: 0 }

      - uses: gitleaks/gitleaks-action@v2
        if: inputs.gitleaks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: trufflesecurity/trufflehog@main
        if: inputs.trufflehog
        with:
          extra_args: --results=verified,unknown

# ---------------------------------------------------------
# üß™ SAST ‚Äì Semgrep
# ---------------------------------------------------------
  sast:
    if: inputs.semgrep
    runs-on: ubuntu-latest
    container: semgrep/semgrep:latest
    steps:
      - uses: actions/checkout@v5
      - run: |
          semgrep scan --config=auto . --sarif > semgrep-results.sarif
      - uses: actions/upload-artifact@v5
        with:
          name: semgrep-results
          path: semgrep-results.sarif

# ---------------------------------------------------------
# üì¶ SBOM + Trivy
# ---------------------------------------------------------
  sbom:
    if: inputs.sbom
    runs-on: ubuntu-latest
    container: node:${{ inputs.node-version }}
    steps:
      - uses: actions/checkout@v5
      - run: |
          npm install --package-lock-only --ignore-scripts --no-audit
          npm install -g @cyclonedx/cyclonedx-npm
          cyclonedx-npm --package-lock-only -o sbom.cdx.json
      - uses: aquasecurity/trivy-action@0.33.1
        if: inputs.trivy
        with:
          scan-type: fs
          format: sarif
          output: trivy.sarif
          severity: CRITICAL
      - uses: actions/upload-artifact@v5
        with:
          name: sbom
          path: sbom.cdx.json
      - uses: actions/upload-artifact@v5
        with:
          name: trivy
          path: trivy.sarif

# ---------------------------------------------------------
# üîé SCA ‚Äì OWASP Dependency Check (FIXED)
# ---------------------------------------------------------
  owasp_depcheck:
    if: inputs.owasp-depcheck
    runs-on: ubuntu-latest
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      OSSINDEX_USER: ${{ secrets.OSSINDEX_USER }}
      OSSINDEX_TOKEN: ${{ secrets.OSSINDEX_TOKEN }}
    steps:
      - uses: actions/checkout@v5

      - run: |
          mkdir -p odc-data odc-reports
          docker pull owasp/dependency-check:${{ inputs.dc-version }}
          docker run --rm \
            -e NVD_API_KEY="$NVD_API_KEY" \
            -e OSSINDEX_USER="$OSSINDEX_USER" \
            -e OSSINDEX_TOKEN="$OSSINDEX_TOKEN" \
            -v "$PWD":/src \
            -v "$PWD/odc-reports":/report \
            owasp/dependency-check:${{ inputs.dc-version }} \
            --scan /src \
            --disableArchive \
            --format HTML \
            --project "juicy-shop" \
            --out /report \
            --nvdApiKey "$NVD_API_KEY"

      - uses: actions/upload-artifact@v5
        with:
          name: dependency-check
          path: odc-reports

# ---------------------------------------------------------
# üê≥ Build & Push Docker image (FIXED)
# ---------------------------------------------------------
  docker_build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.GITHUB_DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
            ${{ env.GITHUB_DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest


# ---------------------------------------------------------
# üåê DAST ‚Äì OWASP ZAP (FIXED)
# ---------------------------------------------------------
  dast:
    if: inputs.zap
    needs: docker_build_and_push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run ZAP
        env:
          IMAGE_TAG: ${{ env.GITHUB_DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
        run: |
          mkdir -p zap-reports
          docker compose -f docker-compose.dast.yml up --abort-on-container-exit zap

      - uses: actions/upload-artifact@v5
        with:
          name: zap-report
          path: zap-reports
